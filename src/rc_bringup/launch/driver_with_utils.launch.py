'''
启动驱动节点和工具节点
主参考,后续化简用
'''
import os
import sys
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import ExecuteProcess,IncludeLaunchDescription,DeclareLaunchArgument,TimerAction
from launch.conditions import IfCondition
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration
from launch_ros.descriptions import ComposableNode
from launch_ros.actions import ComposableNodeContainer, Node 
from launch.substitutions import Command, PathJoinSubstitution, FindExecutable

def generate_launch_description():
    ld=LaunchDescription()
    ld.add_action(DeclareLaunchArgument('use_extern_imu',default_value='false',description='Start extern imu node if use is True'))
    ld.add_action(DeclareLaunchArgument('use_imu_transform',default_value='true',description='Start imu transform node if use is True'))
    ld.add_action(DeclareLaunchArgument('record_lidar',default_value='true',description='Record lidar data if use is True'))
    ld.add_action(DeclareLaunchArgument('record_imu',default_value='true',description='Record imu data if use is True'))
    # ld.add_action(DeclareLaunchArgument('topic_blacklist',default_value=['*/compressed*']))
    get_package_share_directory('my_driver')
    get_package_share_directory('rc_bringup')
    #启动mid360
    mid360_launch=IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('my_driver'),'launch','mid360_bringup.launch.py')
        ),
        launch_arguments={
            'use_rviz': 'false',  #不启动rviz
        }.items(),
    )
    #启动imu转换
    imu_transform_launch=IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('perception'),'launch','imu_transform.launch.py')
        ),
        condition=IfCondition(LaunchConfiguration('use_imu_transform'))
    )
    #启动utils
    utils_launch=IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('rc_bringup'),'launch','utils_bringup.launch.py')
        ),
    )
    #启动手柄
    joy_launch=IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('my_driver'),'launch','joy.launch.py')
        ),
    )
    #启动下位机通信
    communicate_node=Node(
        package='my_driver',
        executable='com.py',
        name='communicate',
        output='screen',
        emulate_tty=True,
        parameters=[
            {'serial_port': '/dev/serial_qh',
             'serial_baudrate':230400,
             }
        ]
    )
    test_car_node=Node(
        package='my_driver',
        executable='test_car_com.py',
        name='test_car_com',
        output='screen',
        emulate_tty=True,
        parameters=[
            {'serial_port': '/dev/serial_qh',
                'serial_baudrate':115200,}])
    #启动fuck_slam
    fuck_slam_node=Node(
        package='my_driver',
        executable='fuck_slam.py',
        name='fuck_slam',
        output='screen',
        emulate_tty=True,
        parameters=[
            {'docker_name':'voxel_slam_container'
            }
        ]
    )
    #启动ms200
    ms200_launch=IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('my_driver'),'launch','ms200_scan.launch.py')
        ),
    )
    ros_bag_node=  Node(
                    # condition=IfCondition(LaunchConfiguration('use_rosbag_record')),
                    package='python_pkg',
                    executable='rosbag_record',
                    name='rosbag_record',
                    output='screen',
                    emulate_tty=True,
                    parameters=[
                        # {'topic_blacklist':LaunchConfiguration("topic_blacklist")}
                        {'topic_blacklist':['*/compressed*']}
                    ]
                )
    ros_bag_action=TimerAction(
        period=5.0,  # Delay in seconds
        actions=[ros_bag_node]
    )
    fusion_node=Node(
        package='perception',
        executable='slam_riqiang.py',
        name='fusion_node',
        output='screen',
        emulate_tty=True,
        parameters=[
            {'base_to_laser': [-0.13255, 0.3288, 0.0]}, #车体到激光雷达的偏移
            {'loc_to_map': [0.5238,-0.6841,-0.01193947]}, # slam原点到地图左下角的偏移
            {'slam_debug': False},  # 是否开启slam调试
        ])
    # ld.add_action(compose_node)
    ld.add_action(fusion_node)
    ld.add_action(mid360_launch)
    ld.add_action(imu_transform_launch)
    ld.add_action(utils_launch)
    ld.add_action(joy_launch)
    # ld.add_action(communicate_node)
    ld.add_action(test_car_node)
    # ld.add_action(ms200_launch)
    ld.add_action(ros_bag_action)
    ld.add_action(fuck_slam_node)
    return ld
     