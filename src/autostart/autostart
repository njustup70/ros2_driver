#!/bin/bash
### BEGIN INIT INFO
# Provides:          ros2_auto_launch
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       Auto-launch ROS2 driver and LIO-SAM containers with Docker Compose
### END INIT INFO

# é…ç½®æ–‡ä»¶è·¯å¾„
LOG_FILE="/home/up70/ros2_driver/src/autostart/startlog.log"
LOCK_FILE="/home/up70/ros2_driver/src/autostart/startlog.lock"

# é¡¹ç›®ç›®å½•å®šä¹‰
LIO_SAM_DIR="/home/up70/slam_docker/lio_sam/.devcontainer"
ROS2_DRIVER_DIR="/home/up70/ros2_driver/.devcontainer"

init_log() {
    local log_dir
    log_dir=$(dirname "$LOG_FILE")
    
    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è¯»å†™æ‰§è¡Œï¼‰[1,4](@ref)
    if [ ! -d "$log_dir" ]; then
        mkdir -p "$log_dir"
        log "ğŸ“ åˆ›å»ºç›®å½•: $log_dir"
    fi
    chmod 777 "$log_dir"
    
    # å¤„ç†æ—¥å¿—æ–‡ä»¶ï¼ˆå­˜åœ¨åˆ™æ›´æ–°æƒé™ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰[2,6](@ref)
    if [ ! -f "$LOG_FILE" ]; then
        touch "$LOG_FILE"
        log "ğŸ“ åˆ›å»ºæ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    fi
    chmod 666 "$LOG_FILE"
    
    # å¤„ç†é”æ–‡ä»¶ï¼ˆå­˜åœ¨åˆ™æ›´æ–°æƒé™ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰[2,7](@ref)
    if [ ! -f "$LOCK_FILE" ]; then
        touch "$LOCK_FILE"
        log "ğŸ”’ åˆ›å»ºé”æ–‡ä»¶: $LOCK_FILE"
    fi
    chmod 666 "$LOCK_FILE"
    
    # è®¾ç½®è„šæœ¬è‡ªèº«æƒé™[6](@ref)
    local script_path
    script_path=$(realpath "$0")
    chmod 755 "$script_path"
    
    log "âœ… æƒé™å·²è®¾ç½®ï¼šç›®å½•($log_dir)=777, æ–‡ä»¶($LOG_FILE,$LOCK_FILE)=666"
}

# æ—¥å¿—è®°å½•å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

# æ¸…ç†ç°æœ‰å®¹å™¨
clean_containers() {
    log "ğŸ§¹ æ¸…ç†ç°æœ‰å®¹å™¨..."
    docker rm -f ros2driver-container lio_sam_container 2>/dev/null
    if [ $? -eq 0 ]; then
        log "âœ… å®¹å™¨å·²æˆåŠŸç§»é™¤"
    else
        log "âš ï¸  æ²¡æœ‰æ‰¾åˆ°è¦ç§»é™¤çš„å®¹å™¨æˆ–å‘ç”Ÿé”™è¯¯"
    fi
}

# å¯åŠ¨LIO-SAMå®¹å™¨
start_lio_sam() {
    log "ğŸš€ å¯åŠ¨LIO-SAMå®¹å™¨..."
    pushd "${LIO_SAM_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${LIO_SAM_DIR}"; return 1; }
    
    # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
    docker compose up -d >> "${LOG_FILE}" 2>&1
    
    # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
    local timeout=30
    while (( timeout-- > 0 )); do
        if docker ps --filter "name=lio_sam_container" --format "{{.Status}}" | grep -q "Up"; then
            log "âœ… LIO-SAMå®¹å™¨å·²å¯åŠ¨"
            LIO_CONTAINER_ID=$(docker ps -qf "name=lio_sam_container")
            log "ğŸ“Œ å®¹å™¨ID: ${LIO_CONTAINER_ID}"
            popd >/dev/null
            return 0
        fi
        sleep 1
    done
    
    log "âŒ LIO-SAMå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
    docker compose logs >> "${LOG_FILE}" 2>&1
    popd >/dev/null
    return 1
}

# å¯åŠ¨ROS2 Driverå®¹å™¨
start_ros2_driver() {
    log "ğŸš€ å¯åŠ¨ROS2 Driverå®¹å™¨..."
    pushd "${ROS2_DRIVER_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${ROS2_DRIVER_DIR}"; return 1; }
    
    # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
    docker compose up -d >> "${LOG_FILE}" 2>&1
    
    # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
    local timeout=30
    while (( timeout-- > 0 )); do
        if docker ps --filter "name=ros2driver-container" --format "{{.Status}}" | grep -q "Up"; then
            log "âœ… ROS2 Driverå®¹å™¨å·²å¯åŠ¨"
            ROS2_CONTAINER_ID=$(docker ps -qf "name=ros2driver-container")
            log "ğŸ“Œ å®¹å™¨ID: ${ROS2_CONTAINER_ID}"
            popd >/dev/null
            return 0
        fi
        sleep 1
    done
    
    log "âŒ ROS2 Driverå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
    docker compose logs >> "${LOG_FILE}" 2>&1
    popd >/dev/null
    return 1
}

# # å¯åŠ¨ROS2åº”ç”¨
# start_ros2_launch() {
#     log "â³ éªŒè¯ROS2 Driverå®¹å™¨çŠ¶æ€..."
    
#     # ç­‰å¾…å®¹å™¨å®Œå…¨å°±ç»ªï¼ˆæ£€æŸ¥ros2å‘½ä»¤æ˜¯å¦å¯ç”¨ï¼‰
#     local timeout=20
#     while (( timeout-- > 0 )); do
#         if docker exec ros2driver-container fish -c "command -v ros2" >/dev/null 2>&1; then
#             break
#         fi
#         sleep 1
#     done
    
#     if (( timeout <= 0 )); then
#         log "âŒ ROS2 Driverå®¹å™¨æœªå°±ç»ªï¼Œros2å‘½ä»¤ä¸å¯ç”¨"
#         return 1
#     fi
    
#     log "ğŸš€ æ‰§è¡Œ: ros2 launch rc_bringup didi.launch.py(æ”¾åŒ…)"
#     docker exec -d ros2driver-container fish -c "ros2 bag play ./rosbag_record/1/07-05-11-06 
#  >> /tmp/ros2_launch.log 2>&1"
    
#     # éªŒè¯åº”ç”¨æ˜¯å¦å¯åŠ¨
#     sleep 3  # ç­‰å¾…è¿›ç¨‹å¯åŠ¨
#     if docker exec ros2driver-container pgrep -f "ros2 launch" >/dev/null; then
#         log "âœ… ROS2åº”ç”¨å·²å¯åŠ¨ (PID: $(docker exec ros2driver-container pgrep -f 'ros2 launch'))"
#         log "ğŸ“‹ åº”ç”¨æ—¥å¿—ä½ç½®: /tmp/ros2_launch.log"
#     else
#         log "âŒ ROS2åº”ç”¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker exec ros2driver-container cat /tmp/ros2_launch.log"
#         return 1
#     fi
# }
# ä¸»å¯åŠ¨å‡½æ•°
start() {
    init_log
    log "ğŸ”’ åˆ›å»ºé”æ–‡ä»¶: $$ > ${LOCK_FILE}"
    echo $$ > "${LOCK_FILE}"
    
    clean_containers
    start_ros2_driver || return 1
    sleep 10
    start_lio_sam 
    log "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨å®Œæˆ"
}


# åœæ­¢æœåŠ¡
stop() {
    log "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
    clean_containers
    
    # åœæ­¢docker composeæœåŠ¡
    pushd "${LIO_SAM_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    pushd "${ROS2_DRIVER_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    
    log "ğŸ”“ ç§»é™¤é”æ–‡ä»¶"
    [ -f "${LOCK_FILE}" ] && rm -f "${LOCK_FILE}"
    log "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
}

# æœåŠ¡çŠ¶æ€æ£€æŸ¥
status() {
    if [ -f "${LOCK_FILE}" ]; then
        log "âœ… æœåŠ¡æ­£åœ¨è¿è¡Œ (PID: $(cat "${LOCK_FILE}"))"
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        docker ps --filter "name=ros2driver-container" | grep -q "Up" && \
            log "  - ROS2 Driverå®¹å™¨: è¿è¡Œä¸­" || log "  - ROS2 Driverå®¹å™¨: æœªè¿è¡Œ"
        docker ps --filter "name=lio_sam_container" | grep -q "Up" && \
            log "  - LIO-SAMå®¹å™¨: è¿è¡Œä¸­" || log "  - LIO-SAMå®¹å™¨: æœªè¿è¡Œ"
    else
        log "âŒ æœåŠ¡æœªè¿è¡Œ"
    fi
}

# ä¸»æ§åˆ¶é€»è¾‘
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0