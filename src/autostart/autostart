#!/bin/bash
### BEGIN INIT INFO
# Provides:          ROBOCON autostart
# Author:           Nagisa 2964793117@qq.com
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       Auto-launch ROS2 driver and LIO-SAM containers with Docker Compose
### END INIT INFO

# é…ç½®æ–‡ä»¶è·¯å¾„
LOG_FILE="/home/up70/ros2_driver/src/autostart/startlog.log"
LOCK_FILE="/home/up70/ros2_driver/src/autostart/startlog.lock"

# é¡¹ç›®ç›®å½•å®šä¹‰
VOXEL_SLAM_DIR="/home/up70/slam_docker/VoxelSlam/.devcontainer"
LIO_SAM_DIR="/home/up70/slam_docker/lio_sam/.devcontainer"
POINT_LIO_DIR="/home/up70/slam_docker/point_lio/.devcontainer"
ROS2_DRIVER_DIR="/home/up70/ros2_driver/.devcontainer"

init_log() {
    mkdir -p "$(dirname "$LOG_FILE")"
    touch "$LOG_FILE"
    # ä½¿ç”¨å½“å‰ç”¨æˆ·ï¼ˆæ¨èï¼‰
    chown $(id -u):$(id -g) "$LOG_FILE"
    chmod 644 "$LOG_FILE"
}

# æ—¥å¿—è®°å½•å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

# æ¸…ç†ç°æœ‰å®¹å™¨
clean_containers() {
    log "ğŸ§¹ æ¸…ç†ç°æœ‰å®¹å™¨..."
    docker rm -f ros2driver-container lio_sam_container voxel_slam_container point_lio_container 2>/dev/null >> "${LOG_FILE}" 2>&1
    if [ $? -eq 0 ]; then
        log "âœ… å®¹å™¨å·²æˆåŠŸç§»é™¤"
    else
        log "âš ï¸  æ²¡æœ‰æ‰¾åˆ°è¦ç§»é™¤çš„å®¹å™¨æˆ–å‘ç”Ÿé”™è¯¯"
    fi
}

# # å¯åŠ¨LIO-SAMå®¹å™¨
# start_lio_sam() {
#     log "ğŸš€ å¯åŠ¨LIO-SAMå®¹å™¨..."
#     pushd "${LIO_SAM_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${LIO_SAM_DIR}"; return 1; }
    
#     # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
#     docker compose up -d >> "${LOG_FILE}" 2>&1
    
#     # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
#     local timeout=30
#     while (( timeout-- > 0 )); do
#         if docker ps --filter "name=lio_sam_container" --format "{{.Status}}" | grep -q "Up"; then
#             log "âœ… LIO-SAMå®¹å™¨å·²å¯åŠ¨"
#             LIO_CONTAINER_ID=$(docker ps -qf "name=lio_sam_container")
#             log "ğŸ“Œ å®¹å™¨ID: ${LIO_CONTAINER_ID}"
#             popd >/dev/null
#             return 0
#         fi
#         sleep 1
#     done
    
#     log "âŒ LIO-SAMå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
#     docker compose logs >> "${LOG_FILE}" 2>&1
#     popd >/dev/null
#     return 1
# }

# å¯åŠ¨Point LIOå®¹å™¨
start_point_lio() {
    log "ğŸš€ å¯åŠ¨Point LIOå®¹å™¨..."
    pushd "${POINT_LIO_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${POINT_LIO_DIR}"; return 1; }
    # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
    docker compose up -d >> "${LOG_FILE}" 2>&1
    # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
    local timeout=30
    while (( timeout-- > 0 )); do
        if docker ps --filter "name=point_lio_container" --format "{{.Status}}" | grep -q "Up"; then
            log "âœ… Point LIOå®¹å™¨å·²å¯åŠ¨"
            POINT_LIO_CONTAINER_ID=$(docker ps -qf "name=point_lio_container")
            log "ğŸ“Œ å®¹å™¨ID: ${POINT_LIO_CONTAINER_ID}"
            popd >/dev/null
            return 0
        fi
        sleep 1
    done
    log "âŒ Point LIOå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
    docker compose logs >> "${LOG_FILE}" 2>&1
    popd >/dev/null
    return 1
}

# å¯åŠ¨VoxelSlamå®¹å™¨
start_voxel_slam() {
    log "ğŸš€ å¯åŠ¨VoxelSlamå®¹å™¨..."
    pushd "${VOXEL_SLAM_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${VOXEL_SLAM_DIR}"; return 1; }
    
    # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
    docker start  voxel_slam_container>> "${LOG_FILE}" 2>&1
    
    # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
    local timeout=30
    while (( timeout-- > 0 )); do
        if docker ps --filter "name=voxel_slam_container" --format "{{.Status}}" | grep -q "Up"; then
            log "âœ… VoxelSlamå®¹å™¨å·²å¯åŠ¨"
            VOXEL_CONTAINER_ID=$(docker ps -qf "name=voxel_slam_container")
            log "ğŸ“Œ å®¹å™¨ID: ${VOXEL_CONTAINER_ID}"
            popd >/dev/null
            return 0
        fi
        sleep 1
    done
    
    log "âŒ VoxelSlamå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
    docker compose logs >> "${LOG_FILE}" 2>&1
    popd >/dev/null
    return 1
}


# å¯åŠ¨ROS2 Driverå®¹å™¨
start_ros2_driver() {
    log "ğŸš€ å¯åŠ¨ROS2 Driverå®¹å™¨..."
    pushd "${ROS2_DRIVER_DIR}" >/dev/null || { log "âŒ æ— æ³•è¿›å…¥ç›®å½•: ${ROS2_DRIVER_DIR}"; return 1; }
    
    # åå°å¯åŠ¨å®¹å™¨å¹¶è®°å½•æ—¥å¿—
    docker start ros2driver-container >> "${LOG_FILE}" 2>&1
    
    # ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆæœ€é•¿30ç§’ï¼‰
    local timeout=30
    while (( timeout-- > 0 )); do
        if docker ps --filter "name=ros2driver-container" --format "{{.Status}}" | grep -q "Up"; then
            log "âœ… ROS2 Driverå®¹å™¨å·²å¯åŠ¨"
            ROS2_CONTAINER_ID=$(docker ps -qf "name=ros2driver-container")
            log "ğŸ“Œ å®¹å™¨ID: ${ROS2_CONTAINER_ID}"
            popd >/dev/null
            return 0
        fi
        sleep 1
    done
    
    log "âŒ ROS2 Driverå®¹å™¨å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker compose logs"
    docker compose logs >> "${LOG_FILE}" 2>&1
    popd >/dev/null
    return 1
}

# å¯åŠ¨ROS2åº”ç”¨
start_ros2_launch() {
    log "â³ éªŒè¯ROS2 Driverå®¹å™¨çŠ¶æ€..."
    
    # ç­‰å¾…å®¹å™¨å®Œå…¨å°±ç»ªï¼ˆæ£€æŸ¥ros2å‘½ä»¤æ˜¯å¦å¯ç”¨ï¼‰
    local timeout=20
    while (( timeout-- > 0 )); do
        if docker exec ros2driver-container fish -c "command -v ros2" >/dev/null 2>&1; then
            break
        fi
        sleep 1
    done
    
    if (( timeout <= 0 )); then
        log "âŒ ROS2 Driverå®¹å™¨æœªå°±ç»ªï¼Œros2å‘½ä»¤ä¸å¯ç”¨"
        return 1
    fi

    # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ROS2åº”ç”¨è¿›ç¨‹
    log "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ROS2åº”ç”¨è¿›ç¨‹..."
    docker exec ros2driver-container fish -c "pkill -f 'ros2 launch rc_bringup didi.launch.py'" 2>/dev/null
    sleep 1  # ç¡®ä¿è¿›ç¨‹å®Œå…¨ç»ˆæ­¢
    
    log "ğŸš€ æ‰§è¡Œ: ros2 launch rc_bringup didi.launch.py"
    docker exec -d ros2driver-container fish -c "ros2 launch rc_bringup didi.launch.py > /tmp/ros2_launch.log 2>&1"
        
    # éªŒè¯åº”ç”¨æ˜¯å¦å¯åŠ¨
    sleep 3  # ç­‰å¾…è¿›ç¨‹å¯åŠ¨
    if docker exec ros2driver-container pgrep -f "ros2 launch rc_bringup didi.launch.py" >/dev/null; then
        log "âœ… ROS2åº”ç”¨å·²å¯åŠ¨ (PID: $(docker exec ros2driver-container pgrep -f 'ros2 launch rc_bringup didi.launch.py'))"
        log "ğŸ“‹ åº”ç”¨æ—¥å¿—ä½ç½®: /tmp/ros2_launch.log"
    else
        log "âŒ ROS2åº”ç”¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: docker exec ros2driver-container cat /tmp/ros2_launch.log"
        return 1
    fi
}

start() {
    init_log
    log "ğŸ”’ åˆ›å»ºé”æ–‡ä»¶: $$ > ${LOCK_FILE}"
    echo $$ > "${LOCK_FILE}"
    
    # clean_containers
    start_ros2_driver || return 1
    sleep 5 
    start_ros2_launch || return 1
    sleep 6
    # start_lio_sam 
    # start_point_lio 
    start_voxel_slam 
    log "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨å®Œæˆ"
}


# åœæ­¢æœåŠ¡
stop() {
    log "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
    clean_containers
    
    # åœæ­¢docker composeæœåŠ¡
    pushd "${LIO_SAM_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    pushd "${ROS2_DRIVER_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    pushd "${VOXEL_SLAM_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    pushd "${POINT_LIO_DIR}" >/dev/null && docker compose down
    popd >/dev/null
    
    log "ğŸ”“ ç§»é™¤é”æ–‡ä»¶"
    [ -f "${LOCK_FILE}" ] && rm -f "${LOCK_FILE}"
    log "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
}

# æœåŠ¡çŠ¶æ€æ£€æŸ¥
status() {
    if [ -f "${LOCK_FILE}" ]; then
        log "âœ… æœåŠ¡æ­£åœ¨è¿è¡Œ (PID: $(cat "${LOCK_FILE}"))"
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        docker ps --filter "name=ros2driver-container" | grep -q "Up" && \
            log "  - ROS2 Driverå®¹å™¨: è¿è¡Œä¸­" || log "  - ROS2 Driverå®¹å™¨: æœªè¿è¡Œ"
        docker ps --filter "name=lio_sam_container" | grep -q "Up" && \
            log "  - LIO-SAMå®¹å™¨: è¿è¡Œä¸­" || log "  - LIO-SAMå®¹å™¨: æœªè¿è¡Œ"
        docker ps --filter "name=voxel_slam_container" | grep -q "Up" && \
            log "  - VoxelSlamå®¹å™¨: è¿è¡Œä¸­" || log "  - VoxelSlamå®¹å™¨: æœªè¿è¡Œ"
        docker ps --filter "name=point_lio_container" | grep -q "Up" && \
            log "  - Point LIOå®¹å™¨: è¿è¡Œä¸­" || log "  - Point LIOå®¹å™¨: æœªè¿è¡Œ"
    else
        log "âŒ æœåŠ¡æœªè¿è¡Œ"
    fi
}

# ä¸»æ§åˆ¶é€»è¾‘
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0
